#!/usr/bin/env bash
set -e

G=$'\033[32m'
R=$'\033[31m'
C=$'\033[36m'
Y=$'\033[33m'
N=$'\033[0m'

pause(){ read -p "Press Enter to continue..." temp; }

typewriter() {
    text="$1"
    for ((i=0; i<${#text}; i++)); do
        echo -ne "${text:$i:1}"
        sleep 0.02
    done
    echo ""
}

boot_animation(){
clear
echo -e "${C}"
typewriter "ğŸš€ Initializing TYRKROX Hyper System..."
sleep 0.5
typewriter "âš™ï¸ Loading Modules..."
sleep 0.5
typewriter "ğŸ” Checking Compatibility..."
sleep 0.5
echo -e "${G}âœ… System Ready${N}"
sleep 1
}

header(){
clear
echo -e "${C}"
echo "=========== ğŸš€ TYRKROX CONTROL PANEL ğŸš€ ==========="
echo "===============   OFFICIAL BUILD   ================"
echo -e "${N}"
}

install_docker(){
if ! command -v docker &> /dev/null; then
    echo -e "${Y}Installing Docker...${N}"
    apt update -y
    apt install -y docker.io
    systemctl enable docker
    systemctl start docker
fi
}

# ================= PANEL =================

panel_menu(){
while true; do
header
echo "ğŸ–¥ï¸ PANEL MANAGEMENT"
echo ""
echo "[1] ğŸ“¥ Install Panel"
echo "[2] ğŸ‘¤ Create Panel User"
echo "[3] ğŸ”„ Update Panel"
echo "[4] ğŸ—‘ï¸ Uninstall Panel"
echo "[0] ğŸ”™ Back"
echo ""

read -p "Select Option: " p
case $p in
1)
apt update -y
apt install -y nginx mysql-server php php-fpm curl unzip
mkdir -p /var/www/panel
echo "TYRKROX PANEL ACTIVE" > /var/www/panel/index.html
systemctl restart nginx
echo "âœ… Panel Installed"
pause ;;
2)
read -p "Username: " user
read -p "Password: " pass
useradd -m $user
echo "$user:$pass" | chpasswd
echo "âœ… User Created"
pause ;;
3)
apt update -y && apt upgrade -y
echo "âœ… Panel Updated"
pause ;;
4)
rm -rf /var/www/panel
apt remove -y nginx mysql-server php*
echo "âŒ Panel Removed"
pause ;;
0) break ;;
*) echo "Invalid"; sleep 1 ;;
esac
done
}

# ================= IVM (Docker Based) =================

ivm_menu(){
install_docker
while true; do
header
echo "ğŸ“¦ IVM MANAGER"
echo ""
echo "[1] â• Create VM"
echo "[2] â–¶ï¸ Start VM"
echo "[3] â¹ï¸ Stop VM"
echo "[4] ğŸ—‘ï¸ Delete VM"
echo "[5] âš™ï¸ Edit VM"
echo "[6] ğŸ“‹ List VMs"
echo "[0] ğŸ”™ Back"
echo ""

read -p "Select Option: " i
case $i in
1)
read -p "VM Name: " NAME
docker run -dit --name $NAME ubuntu:22.04
echo "âœ… VM Created"
pause ;;
2)
read -p "VM Name: " NAME
docker start $NAME
pause ;;
3)
read -p "VM Name: " NAME
docker stop $NAME
pause ;;
4)
read -p "VM Name: " NAME
docker rm -f $NAME
pause ;;
5)
read -p "VM Name: " NAME
read -p "New RAM (MB): " RAM
read -p "New CPU Limit: " CPU
docker update --memory="${RAM}m" --cpus="$CPU" $NAME
echo "âœ… VM Updated"
pause ;;
6)
docker ps -a
pause ;;
0) break ;;
*) echo "Invalid"; sleep 1 ;;
esac
done
}

# ================= KVM MANAGER =================

create_kvm_vm(){
header
if ! egrep -q '(vmx|svm)' /proc/cpuinfo; then
echo "âŒ KVM Not Supported On This Machine"
pause
return
fi

echo "ğŸ†• CREATE NEW VM"
read -p "ğŸ“› VM Name: " VMNAME
read -p "ğŸ’¾ RAM (MB): " RAM
read -p "ğŸ§  CPU Cores: " CPU
read -p "ğŸ—„ï¸ Disk Size (GB): " DISK
read -p "ğŸ“€ ISO Path: " ISO

qemu-img create -f qcow2 /var/lib/libvirt/images/$VMNAME.qcow2 ${DISK}G

virt-install \
--name $VMNAME \
--ram $RAM \
--vcpus $CPU \
--disk path=/var/lib/libvirt/images/$VMNAME.qcow2 \
--cdrom $ISO \
--os-type linux \
--network network=default \
--graphics vnc \
--noautoconsole

echo "âœ… VM Created Successfully"
pause
}

kvm_menu(){
while true; do
header
echo "ğŸ’» KVM MANAGER"
echo ""
echo "[1] ğŸ†• Create New VM"
echo "[2] ğŸ“‹ List VMs"
echo "[3] â–¶ï¸ Start VM"
echo "[4] â¹ï¸ Stop VM"
echo "[5] ğŸ—‘ï¸ Delete VM"
echo "[0] ğŸ”™ Back"
echo ""

read -p "Select Option: " k
case $k in
1) create_kvm_vm ;;
2) virsh list --all; pause ;;
3) read -p "VM Name: " VM; virsh start $VM; pause ;;
4) read -p "VM Name: " VM; virsh shutdown $VM; pause ;;
5) read -p "VM Name: " VM; virsh undefine $VM; pause ;;
0) break ;;
*) echo "Invalid"; sleep 1 ;;
esac
done
}

# ================= WINGS =================

install_wings(){
install_docker
echo "ğŸ³ Wings Docker Environment Ready"
pause
}

# ================= PROXMOX (YOUR FULL COMMAND ADDED) =================

install_proxmox(){
install_docker

docker run -itd \
  --name proxmoxve \
  --hostname pve \
  --privileged \
  --cgroupns=host \
  --security-opt apparmor=unconfined \
  --security-opt seccomp=unconfined \
  -v /sys/fs/cgroup:/sys/fs/cgroup:rw \
  -v /lib/modules:/lib/modules:ro \
  -v /dev/fuse:/dev/fuse \
  -v /sys/kernel/debug:/sys/kernel/debug \
  -p 8006:8006 \
  --restart unless-stopped \
  rtedpro/proxmox:9.0.11

echo "ğŸŒ Proxmox Started On: https://SERVER-IP:8006"
pause
}

# ================= START =================

boot_animation

while true; do
header
echo "[1] ğŸ–¥ï¸ Panel Install"
echo "[2] ğŸ³ Install Wings"
echo "[3] ğŸ“¦ IVM Manager"
echo "[4] ğŸ’» KVM Manager"
echo "[5] ğŸŒ Install Proxmox"
echo "[0] âŒ Exit"
echo ""

read -p "Select Option: " opt
case $opt in
1) panel_menu ;;
2) install_wings ;;
3) ivm_menu ;;
4) kvm_menu ;;
5) install_proxmox ;;
0) exit 0 ;;
*) echo "Invalid"; sleep 1 ;;
esac
done
