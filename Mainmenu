#!/usr/bin/env bash
set -e

G=$'\033[32m'
R=$'\033[31m'
C=$'\033[36m'
Y=$'\033[33m'
N=$'\033[0m'

pause(){ read -p "Press Enter to continue..." temp; }

# ================= LOGO =================

logo(){
echo -e "${C}"
echo "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—"
echo "â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•"
echo "   â–ˆâ–ˆâ•‘    â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ•”â• "
echo "   â–ˆâ–ˆâ•‘     â•šâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— "
echo "   â–ˆâ–ˆâ•‘      â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•—"
echo "   â•šâ•â•      â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•"
echo -e "${N}"
}

boot(){
clear
logo
echo -e "${C}ðŸš€ Initializing TYRKROX Hyper System...${N}"
sleep 0.5
echo -e "${G}âœ… System Ready${N}"
sleep 1
}

kvm_status(){
if egrep -q '(vmx|svm)' /proc/cpuinfo; then
echo -e "${G}KVM Mode: ENABLED${N}"
else
echo -e "${R}KVM Mode: DISABLED${N}"
fi
}

header(){
clear
logo
echo -e "${C}=========== TYRKROX CONTROL PANEL ===========${N}"
kvm_status
echo ""
}

# ================= DOCKER =================

install_docker(){
if ! command -v docker &> /dev/null; then
echo -e "${Y}Installing Docker...${N}"
apt update -y
apt install -y docker.io
systemctl enable docker
systemctl start docker
fi
}

# ================= KVM INSTALL =================

install_kvm(){
if ! command -v virsh &> /dev/null; then
echo -e "${Y}Installing KVM...${N}"
apt update -y
apt install -y qemu-kvm libvirt-daemon-system libvirt-clients virtinst
systemctl enable libvirtd
systemctl start libvirtd
fi
}

# ================= IVM =================

ivm_menu(){
install_docker
while true; do
header
echo "ðŸ“¦ IVM MANAGER"
echo "[1] Create VM"
echo "[2] Start VM"
echo "[3] Stop VM"
echo "[4] Delete VM"
echo "[5] List VMs"
echo "[6] VM Info"
echo "[0] Back"
echo ""

read -p "Select: " i
case $i in
1)
echo "Select OS:"
echo "1) Ubuntu 22.04"
echo "2) Ubuntu 24.04"
echo "3) Debian 12"
read -p "Choose: " os
case $os in
1) IMAGE="ubuntu:22.04" ;;
2) IMAGE="ubuntu:24.04" ;;
3) IMAGE="debian:12" ;;
*) IMAGE="ubuntu:22.04" ;;
esac
read -p "VM Name: " NAME
docker pull $IMAGE
docker run -dit --name $NAME --restart unless-stopped $IMAGE sleep infinity
echo "VM Created"
pause ;;
2) read -p "VM Name: " NAME; docker start $NAME; pause ;;
3) read -p "VM Name: " NAME; docker stop $NAME; pause ;;
4) read -p "VM Name: " NAME; docker rm -f $NAME; pause ;;
5) docker ps -a; pause ;;
6) read -p "VM Name: " NAME; docker inspect $NAME; pause ;;
0) break ;;
*) echo "Invalid"; sleep 1 ;;
esac
done
}

# ================= KVM =================

kvm_menu(){
install_kvm
while true; do
header
echo "ðŸ’» KVM MANAGER"
echo "[1] Create VM"
echo "[2] List VMs"
echo "[3] Start VM"
echo "[4] Stop VM"
echo "[5] Delete VM"
echo "[6] VM Info"
echo "[7] Resize Disk"
echo "[0] Back"
echo ""

read -p "Select: " k
case $k in
1)
read -p "VM Name: " NAME
read -p "RAM MB: " RAM
read -p "CPU Cores: " CPU
read -p "Disk GB: " DISK
qemu-img create -f qcow2 /var/lib/libvirt/images/$NAME.qcow2 ${DISK}G
virt-install --name $NAME --ram $RAM --vcpus $CPU \
--disk path=/var/lib/libvirt/images/$NAME.qcow2 \
--os-variant ubuntu22.04 \
--network network=default \
--graphics vnc --noautoconsole
pause ;;
2) virsh list --all; pause ;;
3) read -p "VM Name: " VM; virsh start $VM; pause ;;
4) read -p "VM Name: " VM; virsh shutdown $VM; pause ;;
5) read -p "VM Name: " VM; virsh undefine $VM --remove-all-storage; pause ;;
6) read -p "VM Name: " VM; virsh dominfo $VM; pause ;;
7) read -p "VM Name: " VM; read -p "New Size GB: " SIZE; qemu-img resize /var/lib/libvirt/images/$VM.qcow2 ${SIZE}G; pause ;;
0) break ;;
*) echo "Invalid"; sleep 1 ;;
esac
done
}

# ================= WINGS =================

install_wings(){
install_docker
echo "Wings Docker Environment Ready"
pause
}

# ================= PROXMOX =================

install_proxmox(){
install_docker
if docker ps -a | grep -q proxmoxve; then
echo "Proxmox Already Installed"
else
docker run -itd \
  --name proxmoxve \
  --hostname pve \
  --privileged \
  --cgroupns=host \
  --security-opt apparmor=unconfined \
  --security-opt seccomp=unconfined \
  -v /sys/fs/cgroup:/sys/fs/cgroup:rw \
  -v /lib/modules:/lib/modules:ro \
  -v /dev/fuse:/dev/fuse \
  -v /sys/kernel/debug:/sys/kernel/debug \
  -p 8006:8006 \
  --restart unless-stopped \
  rtedpro/proxmox:9.0.11
fi
echo "Access Proxmox: https://SERVER-IP:8006"
pause
}

# ================= MAIN =================

boot

while true; do
header
echo "[1] Panel Management"
echo "[2] Install Wings"
echo "[3] IVM Manager"
echo "[4] KVM Manager"
echo "[5] Install Proxmox"
echo "[0] Exit"
echo ""

read -p "Select: " opt
case $opt in
1) panel_menu ;;
2) install_wings ;;
3) ivm_menu ;;
4) kvm_menu ;;
5) install_proxmox ;;
0) exit 0 ;;
*) echo "Invalid"; sleep 1 ;;
esac
done
