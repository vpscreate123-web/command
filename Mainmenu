#!/usr/bin/env bash

set -u

# ==== COLORS ====
G=$'\033[32m'
R=$'\033[31m'
C=$'\033[36m'
Y=$'\033[33m'
N=$'\033[0m'

panel_status() {
if [ -d "/var/www/pterodactyl" ]; then
echo -e "PANEL STATUS: ${G}INSTALLED âœ”${N}"
else
echo -e "PANEL STATUS: ${R}NOT INSTALLED âœ–${N}"
fi
}

header() {
clear
echo -e "${C}"
cat << "EOF"
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— 
â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
   â–ˆâ–ˆâ•‘    â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
   â–ˆâ–ˆâ•‘     â•šâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
   â–ˆâ–ˆâ•‘      â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
   â•šâ•â•      â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•
EOF
echo -e "${Y}ðŸš€ TYRKROX_GAMER SERVER MANAGER ðŸš€${N}"
echo ""
}

pause(){ read -p "Press Enter to continue..." dummy; }

# =========================
# FULL PANEL INSTALL
# =========================
install_panel_full() {

clear
echo "==== FULL AUTO PANEL INSTALL ===="

read -p "Enter Domain: " DOMAIN
read -p "Admin Email: " EMAIL
read -p "Admin Username: " USERNAME
read -p "Admin First Name: " FIRST
read -p "Admin Last Name: " LAST
read -p "Admin Password: " PASS

DBPASS=$(openssl rand -base64 12)

apt update -y
apt install -y nginx mysql-server redis-server curl tar unzip git docker.io certbot python3-certbot-nginx \
php php-cli php-fpm php-mysql php-gd php-mbstring php-bcmath php-xml php-curl php-zip

systemctl enable docker --now

mysql -e "CREATE DATABASE panel;"
mysql -e "CREATE USER 'ptero'@'127.0.0.1' IDENTIFIED BY '$DBPASS';"
mysql -e "GRANT ALL PRIVILEGES ON panel.* TO 'ptero'@'127.0.0.1'; FLUSH PRIVILEGES;"

mkdir -p /var/www/pterodactyl
cd /var/www/pterodactyl

curl -Lo panel.tar.gz https://github.com/pterodactyl/panel/releases/latest/download/panel.tar.gz
tar -xzvf panel.tar.gz
cp .env.example .env

curl -sS https://getcomposer.org/installer | php
mv composer.phar /usr/local/bin/composer
composer install --no-dev --optimize-autoloader

php artisan key:generate --force
php artisan migrate --seed --force

php artisan p:user:make <<EOF
$EMAIL
$USERNAME
$FIRST
$LAST
$PASS
yes
EOF

chown -R www-data:www-data /var/www/pterodactyl

cat > /etc/nginx/sites-available/pterodactyl.conf <<EOL
server {
listen 80;
server_name $DOMAIN;
root /var/www/pterodactyl/public;
index index.php;
location / { try_files \$uri \$uri/ /index.php?\$query_string; }
location ~ \.php$ {
fastcgi_pass unix:/run/php/php-fpm.sock;
include fastcgi_params;
fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
}
}
EOL

ln -s /etc/nginx/sites-available/pterodactyl.conf /etc/nginx/sites-enabled/
systemctl restart nginx

certbot --nginx -d $DOMAIN --non-interactive --agree-tos -m $EMAIL

echo "Installing Wings..."
curl -L -o /usr/local/bin/wings https://github.com/pterodactyl/wings/releases/latest/download/wings_linux_amd64
chmod +x /usr/local/bin/wings

echo "Panel Installed: https://$DOMAIN"
echo "Database Password: $DBPASS"

pause
}

# =========================
# WINGS ONLY INSTALL
# =========================
install_wings() {
apt install -y docker.io
systemctl enable docker --now
curl -L -o /usr/local/bin/wings https://github.com/pterodactyl/wings/releases/latest/download/wings_linux_amd64
chmod +x /usr/local/bin/wings
echo "Wings Installed."
pause
}

# =========================
# PANEL MANAGER
# =========================
panel_manager() {
while true; do
clear
echo "==== PTERODACTYL MANAGER ===="
panel_status
echo "[1] Create User"
echo "[2] Update Panel"
echo "[3] Reinstall SSL"
echo "[4] Uninstall Panel"
echo "[5] Back"
read -p "Choice: " pm

case $pm in
1) cd /var/www/pterodactyl && php artisan p:user:make ;;
2) cd /var/www/pterodactyl && php artisan p:upgrade ;;
3) read -p "Domain: " d; read -p "Email: " e; certbot --nginx -d $d -m $e --agree-tos ;;
4) rm -rf /var/www/pterodactyl && echo "Removed." ;;
5) break ;;
*) echo "Invalid"; sleep 2 ;;
esac
pause
done
}

# =========================
# MAIN MENU
# =========================
while true; do
header
panel_status
echo "[1] Install Full Panel + Wings + SSL"
echo "[2] Install Wings Only"
echo "[3] Panel Manager"
echo "[4] Install Proxmox (Docker)"
echo "[5] Exit"
read -p "Select: " choice

case $choice in
1) install_panel_full ;;
2) install_wings ;;
3) panel_manager ;;
4)
docker run -itd \
--name proxmoxve \
--hostname pve \
--privileged \
-p 8006:8006 \
--restart unless-stopped \
rtedpro/proxmox:9.0.11
pause ;;
5) exit 0 ;;
*) echo "Invalid option"; sleep 2 ;;
esac
done
